#!/usr/bin/env bash

# Directory for thumbnails
cache_dir="$HOME/.cache/cliphist"
mkdir -p "$cache_dir"

# If an argument is passed, it means we selected an item to copy
if [ "$#" -eq 1 ]; then
    echo "$1" | cliphist decode | wl-copy
    exit 0
fi

# List items and handle icons
cliphist list | while read -r line; do
    id=$(echo "$line" | cut -f1)
    # Create a filename for the thumbnail
    thumb="$cache_dir/$id.png"
    
    # If it's an image and no thumbnail exists, create it
    if ! [ -f "$thumb" ]; then
        # Check if the entry is actually an image
        if cliphist decode "$id" | file -b - | grep -qiE 'image|graphics'; then
            cliphist decode "$id" > "$thumb"
        fi
    fi

    # If the thumbnail exists, tell Rofi to use it as an icon
    if [ -f "$thumb" ]; then
        echo -en "$line\0icon\x1f$thumb\n"
    else
        echo -en "$line\n"
    fi
done
